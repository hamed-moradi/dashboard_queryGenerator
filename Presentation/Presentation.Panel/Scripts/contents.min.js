function checkPartNo(n){for(var i=getAttachments(),t=0;t<i.length;t++)if(i[t].PartNo==n.PartNo&&i[t].QualityId==n.QualityId)return alert("این بخش با این کیفیت قبلا ثبت شده است."),!1;return!0}function saveAttachment(){var n,t,i,r,u,f;if($("#form-attachment").validationEngine("validate")){if(n={Id:$("#attachmentId").val()==null||$("#attachmentId").val()===""?(new Date).getTime():$("#attachmentId").val(),GroupTitle:$("#groupTitle").val(),Title:$("#title").val(),Description:$("#description").val(),Path:$("#path").val(),AttachmentTypeTitle:$("#attachmentType option:selected").text(),PartNo:parseInt($("#partNo").val()),TypeId:$("#attachmentType").val(),IsFree:document.getElementById("isFree").checked,QualityId:$("#Attachquality").val(),QualityTypeTitle:$("#Attachquality option:selected").text(),Status:$("#attachstatus").val(),StatusTitle:$("#attachstatus option:selected").text()},page_action=="edit"&&(n.ContentId=modelId),n.PartNo<=0){alert("شماره بخش درست نمی باشد.");return}if(t=[],parseInt(n.TypeId)!=videoAttachmentType){if(n.Path=$("#medium-path").val(),n.Path==""||n.Path==null){alert("فایل اتنخاب نشده است.");return}n.Id=$("#medium-attachmentId").val()==null||$("#medium-attachmentId").val()===""?(new Date).getTime():$("#medium-attachmentId").val();n.QualityId=2;n.QualityTypeTitle=$("#attachmentType option[value='"+n.QualityId+"']").text();t.push(n)}else{if($("#low-path").val().trim()!=""&&(i=jQuery.extend(!0,{},n),i.Id=$("#low-attachmentId").val()==null||$("#low-attachmentId").val()===""?(new Date).getTime():$("#low-attachmentId").val(),i.QualityId=1,i.QualityTypeTitle=$("#attachmentType option[value='"+i.QualityId+"']").text(),i.Path=$("#low-path").val(),t.push(i)),$("#medium-path").val().trim()!=""&&(r=jQuery.extend(!0,{},n),r.Id=$("#medium-attachmentId").val()==null||$("#medium-attachmentId").val()===""?(new Date).getTime():$("#medium-attachmentId").val(),r.QualityId=2,r.QualityTypeTitle=$("#attachmentType option[value='"+r.QualityId+"']").text(),r.Path=$("#medium-path").val(),t.push(r)),$("#high-path").val().trim()!=""&&(u=jQuery.extend(!0,{},n),u.Id=$("#high-attachmentId").val()==null||$("#high-attachmentId").val()===""?(new Date).getTime():$("#high-attachmentId").val(),u.QualityId=3,u.QualityTypeTitle=$("#attachmentType option[value='"+u.QualityId+"']").text(),u.Path=$("#high-path").val(),t.push(u)),$("#best-path").val().trim()!=""&&(f=jQuery.extend(!0,{},n),f.Id=$("#best-attachmentId").val()==null||$("#best-attachmentId").val()===""?(new Date).getTime():$("#best-attachmentId").val(),f.QualityId=4,f.QualityTypeTitle=$("#attachmentType option[value='"+f.QualityId+"']").text(),f.Path=$("#best-path").val(),t.push(f)),t.length==0){alert("هیچ فایلی اتنخاب نشده است.");return}$("#low-path").val().trim()==""&&$("#low-attachmentId").val()!=null&&$("#low-attachmentId").val()!=""&&deleteAttachmentById($("#low-attachmentId").val());$("#medium-path").val().trim()==""&&$("#medium-attachmentId").val()!=null&&$("#medium-attachmentId").val()!=""&&deleteAttachmentById($("#medium-attachmentId").val());$("#high-path").val().trim()==""&&$("#high-attachmentId").val()!=null&&$("#high-attachmentId").val()!=""&&deleteAttachmentById($("#high-attachmentId").val());$("#best-path").val().trim()==""&&$("#best-attachmentId").val()!=null&&$("#best-attachmentId").val()!=""&&deleteAttachmentById($("#best-attachmentId").val())}addUpdateAttachments(t)}}function addUpdateAttachments(n){$.each(n,function(){var n=!1;if(parseInt(this.TypeId)==videoAttachmentType)switch(this.QualityId){case 1:n=$("#low-attachmentId").val()==null||$("#low-attachmentId").val()==="";break;case 2:n=$("#medium-attachmentId").val()==null||$("#medium-attachmentId").val()==="";break;case 3:n=$("#high-attachmentId").val()==null||$("#high-attachmentId").val()==="";break;case 4:n=$("#best-attachmentId").val()==null||$("#best-attachmentId").val()===""}else n=$("#medium-attachmentId").val()==null||$("#medium-attachmentId").val()==="";if(n){if(!checkPartNo(this))return;this.UniqueId=this.Id;addAttachment(this)}else updateAttachment(this)});cleanTable();SortTableRows();clearAttachment()}function cleanTable(){$("#table-attachments tr:not(.head)").each(function(){var n=$(this).attr("data-partno"),t=getArrayIndexForKey(contentAttachments,"PartNo",n);t==-1&&$(this).remove()})}function editAttachment(n){$("#btnAdd").removeAttr("disabled").show();var t=$.grep(contentAttachments,function(t){return t.PartNo==n});if(t==null||t.length==0){alert("پیوست انتخابی معتبر نمی باشد.");return}$("#title").val(t[0].Title);$("#description").val(t[0].Description);$("#attachmentType").val(t[0].TypeId).attr("disabled","disabled");$("#attachmentType").change();$("#partNo").val(t[0].PartNo);document.getElementById("isFree").checked=t[0].IsFree;$("#attachstatus").val(t[0].Status);$("#title").focus();parseInt(t[0].TypeId)!=videoAttachmentType?($("#medium-path").val(t[0].Path),$("#medium-attachmentId").val(t[0].Id)):$.each(t,function(){switch(parseInt(this.QualityId)){case 1:$("#low-path").val(this.Path);$("#low-attachmentId").val(this.Id);break;case 2:$("#medium-path").val(this.Path);$("#medium-attachmentId").val(this.Id);break;case 3:$("#high-path").val(this.Path);$("#high-attachmentId").val(this.Id);break;case 4:$("#best-path").val(this.Path);$("#best-attachmentId").val(this.Id)}})}function addAttachment(n){var t;if($("tr[data-partno="+n.PartNo+"]").length>0)$($("tr[data-partno="+n.PartNo+"]")[0].cells[0]).html(n.Title),$($("tr[data-partno="+n.PartNo+"]")[0].cells[1]).html(n.AttachmentTypeTitle),$($("tr[data-partno="+n.PartNo+"]")[0].cells[2]).html(n.PartNo),$($("tr[data-partno="+n.PartNo+"]")[0].cells[3]).html("<input "+(n.IsFree?"checked":"")+" class='check-box' disabled type='checkbox'>"),$($("tr[data-partno="+n.PartNo+"]")[0].cells[4]).html(n.StatusTitle);else{t=$("<tr/>").attr("id",n.Id).attr("class","row-attachment").attr("data-PartNo",n.PartNo);t.append($("<td/>").html(n.Title));t.append($("<td/>").html(n.AttachmentTypeTitle));t.append($("<td/>").html(n.PartNo));t.append($("<td/>").html("<input "+(n.IsFree?"checked":"")+" class='check-box' disabled type='checkbox'>"));t.append($("<td/>").html(n.StatusTitle));var i=$("<td/>"),r=$("<a/>").attr("onclick","viewAttachment("+n.PartNo+");").attr("style","cursor:pointer;").addClass("btnEdit").html("مشاهده"),u=$("<a/>").attr("onclick","deleteAttachmentByPartNo("+n.PartNo+");").attr("style","cursor:pointer;").addClass("btnRemove").html("حذف");i.append(r).append($("<span/>").html(" | ")).append(u);t.append(i);$("#table-attachments").append(t)}contentAttachments.push(n)}function viewAttachment(n){editAttachment(n);$("#btnAdd").attr("disabled","disabled").hide()}function SortTableRows(){var n=$("#table-attachments"),t=n.find("tr:not(.head)").get();t.sort(function(n,t){var i=parseInt($(n).attr("data-partno")),r=parseInt($(t).attr("data-partno"));return i<r?-1:i>r?1:0});$.each(t,function(t,i){n.children("tbody").append(i)})}function updateAttachment(n){var t=getArrayIndexForKey(contentAttachments,"Id",n.Id),r,i;if(contentAttachments[t].Id=n.Id,contentAttachments[t].Title=n.Title,contentAttachments[t].Description=n.Description,contentAttachments[t].Path=n.Path,contentAttachments[t].TypeId=n.TypeId,contentAttachments[t].AttachmentTypeTitle=n.AttachmentTypeTitle,contentAttachments[t].PartNo=n.PartNo,contentAttachments[t].IsFree=n.IsFree,contentAttachments[t].QualityId=n.QualityId,contentAttachments[t].QualityTypeTitle=n.QualityTypeTitle,contentAttachments[t].Status=n.Status,contentAttachments[t].StatusTitle=n.StatusTitle,r=$("tr[data-partno="+n.PartNo+"]").length,r==0){i=$("<tr/>").attr("id",n.Id).attr("class","row-attachment").attr("data-PartNo",n.PartNo);i.append($("<td/>").html(n.Title));i.append($("<td/>").html(n.AttachmentTypeTitle));i.append($("<td/>").html(n.PartNo));i.append($("<td/>").html("<input "+(n.IsFree?"checked":"")+" class='check-box' disabled type='checkbox'>"));i.append($("<td/>").html(n.StatusTitle));var u=$("<td/>"),f=$("<a/>").attr("onclick","viewAttachment("+n.PartNo+");").attr("style","cursor:pointer;").addClass("btnEdit").html("مشاهده"),e=$("<a/>").attr("onclick","deleteAttachmentByPartNo("+n.PartNo+");").attr("style","cursor:pointer;").addClass("btnRemove").html("حذف");u.append(f).append($("<span/>").html(" | ")).append(e);i.append(u);$("#table-attachments").append(i)}else r>1&&$("tr[data-partno="+n.PartNo+"]").slice(1).remove(),$($("tr[data-partno="+n.PartNo+"]")[0].cells[0]).html(n.Title),$($("tr[data-partno="+n.PartNo+"]")[0].cells[1]).html(n.AttachmentTypeTitle),$($("tr[data-partno="+n.PartNo+"]")[0].cells[2]).html(n.PartNo),$($("tr[data-partno="+n.PartNo+"]")[0].cells[3]).html("<input "+(n.IsFree?"checked":"")+" class='check-box' disabled type='checkbox'>"),$($("tr[data-partno="+n.PartNo+"]")[0].cells[4]).html(n.StatusTitle),$('a[data-id="edit-'+n.UniqueId+'"]').attr("onclick","editAttachment("+n.PartNo+");"),$('a[data-id="remove-'+n.UniqueId+'"]').attr("onclick","deleteAttachmentByPartNo("+n.PartNo+");")}function getAttachments(){for(var n=contentAttachments,t=0;t<n.length;t++)n[t].Id!=null&&n[t].Id.toString().length>8&&(n[t].Id=null),(n[t].Description==null||n[t].Description==="")&&(n[t].Description=" ");return n}function clearAttachment(){$("#best-attachmentId,#low-attachmentId,#medium-attachmentId,#high-attachmentId").val("");$("#title").val("");$("#description").val("");$("#low-path,#medium-path,#high-path,#best-path").val("");$("#attachmentType").val("").removeAttr("disabled");$("#attachmentType").change();$("#partNo").val(0);$("#refrenceId").val(0);$("#isFree").removeAttr("checked");$("#Attachquality").val("");$("#attachstatus").val("");$("#btnAdd").removeAttr("disabled").show()}function deleteAttachmentByPartNo(n){contentAttachments=contentAttachments.filter(function(t){return parseInt(t.PartNo)!==parseInt(n)});$($("tr[data-PartNo="+n+"]")[0]).remove()}function deleteAttachmentById(n){var t=contentAttachments.filter(function(t){return parseInt(t.Id)==parseInt(n)})[0].UniqueId;contentAttachments=contentAttachments.filter(function(t){return parseInt(t.Id)!==parseInt(n)});contentAttachments.filter(function(n){return n.UniqueId==t}).length==0&&$($("#"+t)[0]).remove()}function getArrayIndexForKey(n,t,i){for(var r=0;r<n.length;r++)if(n[r][t]==i)return r;return-1}var videoAttachmentType=4;$("#btnAdd").click(function(){saveAttachment()});$("#attachmentType").change(function(){parseInt($(this).val())==videoAttachmentType?($("#PathGroup1,#PathGroup3,#PathGroup4").slideDown(),$("#PathGroup2>label").html("فایل کیفیت متوسط")):($("#PathGroup1,#PathGroup3,#PathGroup4").slideUp(),$("#PathGroup2>label").html("مسیر فایل"))});$("#btn-cancel").click(function(){$("#attachmentType").removeAttr("disabled");clearAttachment()});$("#btnSave").click(function(){var t,n,i,r;$("#message").html("");t=[];$($("#tree-categories").jstree("get_checked",null,!0)).each(function(){t.push(this)});$("#form-content").validationEngine("validate")&&(n={Title:$("#Title").val(),Summary:$("#Summary").val(),Body:CKEDITOR.instances.Body.getData(),Price:parseInt($("#Price").val()),Priority:parseInt($("#Priority").val()),Thumbnail:$("#Thumbnail").val(),Photo:$("#Photo").val(),CategoryId:t,FromGrade:parseInt($("#FromGrade").val()),ToGrade:parseInt($("#ToGrade").val()),Tags:null,Positions:null,StartShowDate:$("#StartShowDate").val(),EndShowDate:$("#EndShowDate").val(),ContentTypeId:$("#ContentTypeId").val(),CommentCount:0,LikeCount:0,ViewCount:0,DisLikeCount:0,Status:$("#Status").val()},i="/Contents/Create",page_action=="edit"&&(n.Id=modelId,i="/Contents/Edit"),r={content:n,ContentAttachments:getAttachments()},$.ajax({url:i,type:"POST",data:JSON.stringify({content:n,ContentAttachments:getAttachments()}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){n.status==200?window.location.href=redirectUrl:$("#message").html(n.message)},error:function(n){console.log(n)}}))});